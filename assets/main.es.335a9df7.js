var N=Object.defineProperty,ee=Object.defineProperties,te=Object.getOwnPropertyDescriptors,q=Object.getOwnPropertySymbols,re=Object.prototype.hasOwnProperty,se=Object.prototype.propertyIsEnumerable,H=(t,e,r)=>e in t?N(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,I=(t,e)=>{for(var r in e||(e={}))re.call(e,r)&&H(t,r,e[r]);if(q)for(var r of q(e))se.call(e,r)&&H(t,r,e[r]);return t},ie=(t,e)=>ee(t,te(e));class oe{constructor(){this.disposers=new Map,this.disposerIDGenCount=-1}add(e,r=this.genDisposerID()){return this.flush(r),this.disposers.set(r,e()),r}addEventListener(e,r,s,i,o=this.genDisposerID()){return this.add(()=>(e.addEventListener(r,s,i),()=>e.removeEventListener(r,s,i)),o),o}setTimeout(e,r,s=this.genDisposerID()){return this.add(()=>{const i=window.setTimeout(()=>{this.remove(s),e()},r);return()=>window.clearTimeout(i)},s)}setInterval(e,r,s=this.genDisposerID()){return this.add(()=>{const i=window.setInterval(e,r);return()=>window.clearInterval(i)},s)}remove(e){const r=this.disposers.get(e);return this.disposers.delete(e),r}flush(e){const r=this.remove(e);if(r)try{r()}catch(s){console.error(s)}}flushAll(){this.disposers.forEach(e=>{try{e()}catch(r){console.error(r)}}),this.disposers.clear()}genDisposerID(){const{MAX_SAFE_INTEGER:e=9007199254740991}=Number;return this.disposerIDGenCount=(this.disposerIDGenCount+1)%e,`disposer-${this.disposerIDGenCount}`}}function ne(t){return t!=null&&typeof t=="object"&&!Array.isArray(t)}function ae(t,e){let r=t.getAttributes();if(r||(t.setAttributes(e),r=t.getAttributes()),!r)throw new Error("[NetlessAppMonaco] No attributes");return ne(e)&&Object.keys(e).forEach(s=>{Object.prototype.hasOwnProperty.call(r,s)||t.updateAttributes([s],e[s])}),r}const h=new WeakMap,M=new WeakMap,v=new WeakMap,j=Symbol("anyProducer"),J=Promise.resolve(),k=Symbol("listenerAdded"),O=Symbol("listenerRemoved");let L=!1;function m(t){if(typeof t!="string"&&typeof t!="symbol")throw new TypeError("eventName must be a string or a symbol")}function D(t){if(typeof t!="function")throw new TypeError("listener must be a function")}function w(t,e){const r=M.get(t);return r.has(e)||r.set(e,new Set),r.get(e)}function S(t,e){const r=typeof e=="string"||typeof e=="symbol"?e:j,s=v.get(t);return s.has(r)||s.set(r,new Set),s.get(r)}function ce(t,e,r){const s=v.get(t);if(s.has(e))for(const i of s.get(e))i.enqueue(r);if(s.has(j)){const i=Promise.all([e,r]);for(const o of s.get(j))o.enqueue(i)}}function K(t,e){e=Array.isArray(e)?e:[e];let r=!1,s=()=>{},i=[];const o={enqueue(n){i.push(n),s()},finish(){r=!0,s()}};for(const n of e)S(t,n).add(o);return{async next(){return i?i.length===0?r?(i=void 0,this.next()):(await new Promise(n=>{s=n}),this.next()):{done:!1,value:await i.shift()}:{done:!0}},async return(n){i=void 0;for(const u of e)S(t,u).delete(o);return s(),arguments.length>0?{done:!0,value:await n}:{done:!0}},[Symbol.asyncIterator](){return this}}}function V(t){if(t===void 0)return F;if(!Array.isArray(t))throw new TypeError("`methodNames` must be an array of strings");for(const e of t)if(!F.includes(e))throw typeof e!="string"?new TypeError("`methodNames` element must be a string"):new Error(`${e} is not Emittery method`);return t}const T=t=>t===k||t===O;class b{static mixin(e,r){return r=V(r),s=>{if(typeof s!="function")throw new TypeError("`target` must be function");for(const n of r)if(s.prototype[n]!==void 0)throw new Error(`The property \`${n}\` already exists on \`target\``);function i(){return Object.defineProperty(this,e,{enumerable:!1,value:new b}),this[e]}Object.defineProperty(s.prototype,e,{enumerable:!1,get:i});const o=n=>function(...u){return this[e][n](...u)};for(const n of r)Object.defineProperty(s.prototype,n,{enumerable:!1,value:o(n)});return s}}static get isDebugEnabled(){if(typeof process!="object")return L;const{env:e}=process||{env:{}};return e.DEBUG==="emittery"||e.DEBUG==="*"||L}static set isDebugEnabled(e){L=e}constructor(e={}){h.set(this,new Set),M.set(this,new Map),v.set(this,new Map),this.debug=e.debug||{},this.debug.enabled===void 0&&(this.debug.enabled=!1),this.debug.logger||(this.debug.logger=(r,s,i,o)=>{o=JSON.stringify(o),typeof i=="symbol"&&(i=i.toString());const n=new Date,u=`${n.getHours()}:${n.getMinutes()}:${n.getSeconds()}.${n.getMilliseconds()}`;console.log(`[${u}][emittery:${r}][${s}] Event Name: ${i}
	data: ${o}`)})}logIfDebugEnabled(e,r,s){(b.isDebugEnabled||this.debug.enabled)&&this.debug.logger(e,this.debug.name,r,s)}on(e,r){D(r),e=Array.isArray(e)?e:[e];for(const s of e)m(s),w(this,s).add(r),this.logIfDebugEnabled("subscribe",s,void 0),T(s)||this.emit(k,{eventName:s,listener:r});return this.off.bind(this,e,r)}off(e,r){D(r),e=Array.isArray(e)?e:[e];for(const s of e)m(s),w(this,s).delete(r),this.logIfDebugEnabled("unsubscribe",s,void 0),T(s)||this.emit(O,{eventName:s,listener:r})}once(e){return new Promise(r=>{const s=this.on(e,i=>{s(),r(i)})})}events(e){e=Array.isArray(e)?e:[e];for(const r of e)m(r);return K(this,e)}async emit(e,r){m(e),this.logIfDebugEnabled("emit",e,r),ce(this,e,r);const s=w(this,e),i=h.get(this),o=[...s],n=T(e)?[]:[...i];await J,await Promise.all([...o.map(async u=>{if(s.has(u))return u(r)}),...n.map(async u=>{if(i.has(u))return u(e,r)})])}async emitSerial(e,r){m(e),this.logIfDebugEnabled("emitSerial",e,r);const s=w(this,e),i=h.get(this),o=[...s],n=[...i];await J;for(const u of o)s.has(u)&&await u(r);for(const u of n)i.has(u)&&await u(e,r)}onAny(e){return D(e),this.logIfDebugEnabled("subscribeAny",void 0,void 0),h.get(this).add(e),this.emit(k,{listener:e}),this.offAny.bind(this,e)}anyEvent(){return K(this)}offAny(e){D(e),this.logIfDebugEnabled("unsubscribeAny",void 0,void 0),this.emit(O,{listener:e}),h.get(this).delete(e)}clearListeners(e){e=Array.isArray(e)?e:[e];for(const r of e)if(this.logIfDebugEnabled("clear",r,void 0),typeof r=="string"||typeof r=="symbol"){w(this,r).clear();const s=S(this,r);for(const i of s)i.finish();s.clear()}else{h.get(this).clear();for(const s of M.get(this).values())s.clear();for(const s of v.get(this).values()){for(const i of s)i.finish();s.clear()}}}listenerCount(e){e=Array.isArray(e)?e:[e];let r=0;for(const s of e){if(typeof s=="string"){r+=h.get(this).size+w(this,s).size+S(this,s).size+S(this).size;continue}typeof s<"u"&&m(s),r+=h.get(this).size;for(const i of M.get(this).values())r+=i.size;for(const i of v.get(this).values())r+=i.size}return r}bindMethods(e,r){if(typeof e!="object"||e===null)throw new TypeError("`target` must be an object");r=V(r);for(const s of r){if(e[s]!==void 0)throw new Error(`The property \`${s}\` already exists on \`target\``);Object.defineProperty(e,s,{enumerable:!1,value:this[s].bind(this)})}}}const F=Object.getOwnPropertyNames(b.prototype).filter(t=>t!=="constructor");Object.defineProperty(b,"listenerAdded",{value:k,writable:!1,enumerable:!0,configurable:!1});Object.defineProperty(b,"listenerRemoved",{value:O,writable:!1,enumerable:!0,configurable:!1});var de=b;function X(t,e,r){return{sceneState:{sceneName:`${t}`,scenePath:`${r}/${t}`,contextPath:r,scenes:Q(e),index:t-1}}}function Q(t){const e=[];for(let r=1;r<=t;++r)e.push({name:String(r)});return e}function le(t){return Math.max(1,t-1)}function ue(t,e){return Math.min(e,t+1)}const fe=350;var l;(function(t){t.Init="Init",t.AttributesUpdate="AttributesUpdate",t.SetAttributes="SetAttributes",t.RegisterMagixEvent="RegisterMagixEvent",t.RemoveMagixEvent="RemoveMagixEvent",t.RemoveAllMagixEvent="RemoveAllMagixEvent",t.RoomStateChanged="RoomStateChanged",t.DispatchMagixEvent="DispatchMagixEvent",t.ReceiveMagixEvent="ReciveMagixEvent",t.NextPage="NextPage",t.PrevPage="PrevPage",t.SDKCreate="SDKCreate",t.OnCreate="OnCreate",t.SetPage="SetPage",t.GetAttributes="GetAttributes",t.Ready="Ready",t.Destroy="Destory",t.StartCreate="StartCreate",t.WrapperDidUpdate="WrapperDidUpdate",t.DisplayIframe="DisplayIframe",t.HideIframe="HideIframe",t.PageTo="PageTo"})(l||(l={}));var _;(function(t){t.WrapperDidMount="WrapperDidMount",t.IframeLoad="IframeLoad"})(_||(_={}));const ge=new Set(["clicker","selector"]),pe={kind:"IframeBridge",setup(t){const e=t.getBox(),r=t.getView(),s=t.getDisplayer(),i=t.getRoom(),o=ae(t,{src:"about:blank",displaySceneDir:"/h5",lastEvent:null,state:{},page:0,maxPage:0}),n=new oe,u=document.createElement("div");Object.assign(u.style,{width:"100%",height:"100%",position:"relative"});const f=document.createElement("iframe");Object.assign(f.style,{width:"100%",height:"100%",border:"none",display:"block"}),u.appendChild(f),e.mountContent(u);let C=()=>{};const $=d=>ge.has(d);if(r){const d=document.createElement("div");Object.assign(d.style,{width:"100%",height:"100%",position:"absolute",top:0,left:0}),u.appendChild(d),t.mountView(d),r.disableCameraTransform=!0,n.add(()=>{const c=()=>{const A=u.getBoundingClientRect().height/fe;r.moveCamera({scale:A,animationMode:"immediately"})},a=new ResizeObserver(c);return a.observe(u),()=>a.disconnect()}),C=c=>{d.style.pointerEvents=c?"none":"auto"},C($(i==null?void 0:i.state.memberState.currentApplianceName))}const R=d=>ie(I({},d),{url:o.src,displaySceneDir:o.displaySceneDir,width:f.scrollWidth,height:f.scrollHeight,useClicker:!0,lastEvent:o.lastEvent}),y=new de,P=new Map,x=()=>{P.forEach((d,c)=>{s.removeMagixEventListener(c,d)}),P.clear()},W=(...d)=>!1,g=d=>{var c;W("[IframeBridge] postMessage %s %O",d.kind,d.payload),(c=f.contentWindow)==null||c.postMessage(JSON.parse(JSON.stringify(d)),"*")},E=(d,c)=>{t.getIsWritable()&&(t.updateAttributes(["lastEvent"],{name:d,payload:c}),i==null||i.dispatchMagixEvent(d,c))},G=()=>{g({kind:l.Init,payload:{attributes:R(o.state),roomState:s.state,currentPage:o.page,observerId:s.observerId}})};let B=o.src.includes("cocos");const U=d=>{G(),y.emit(_.IframeLoad,d),y.on(l.Ready,()=>{var c,a;(c=o.lastEvent)!=null&&c.payload&&g((a=o.lastEvent)==null?void 0:a.payload)}),B&&(setTimeout(()=>{g({kind:l.RoomStateChanged,payload:X(1,o.maxPage,o.displaySceneDir)})},500),B=!1),f.removeEventListener("load",U)};n.addEventListener(f,"load",U);let Y=0;const Z=()=>{Y++<3&&(f.src=o.src)};n.addEventListener(f,"error",Z),f.src=o.src,n.add(()=>t.mobxUtils.autorun(()=>{g({kind:l.AttributesUpdate,payload:R(o.state)})})),n.add(()=>t.mobxUtils.autorun(()=>{f.src=o.src})),n.add(()=>t.mobxUtils.autorun(()=>{g({kind:l.RoomStateChanged,payload:X(o.page,o.maxPage,o.displaySceneDir)})}));const z={emitter:y,postMessage:g,context:t};return y.emit(l.StartCreate),y.emit(l.OnCreate,z),i&&n.add(()=>{const d=c=>{c.memberState&&C($(c.memberState.currentApplianceName))};return i.callbacks.on("onRoomStateChanged",d),()=>i.callbacks.off("onRoomStateChanged",d)}),n.addEventListener(window,"message",d=>{if(d.source!==f.contentWindow)return;const c=d.data;switch(W("[IframeBridge] received",c.kind,c.payload),c.kind){case l.SetAttributes:{t.updateAttributes(["state"],I(I({},o.state),c.payload));break}case l.RegisterMagixEvent:{const a=A=>{A.authorId!==s.observerId&&g({kind:l.ReceiveMagixEvent,payload:A})},p=c.payload;P.set(p,a),s.addMagixEventListener(p,a);break}case l.RemoveMagixEvent:{const a=c.payload,p=P.get(a);s.removeMagixEventListener(a,p);break}case l.DispatchMagixEvent:{const a=c.payload;E(a.event,a.payload);break}case l.RemoveAllMagixEvent:{x();break}case l.NextPage:{if(t.getIsWritable()&&i){const a=ue(o.page,o.maxPage);if(a===o.page)break;t.setScenePath([o.displaySceneDir,a].join("/")),t.updateAttributes(["page"],a),E(l.NextPage,{})}break}case l.PrevPage:{if(t.getIsWritable()&&i){const a=le(o.page);if(a===o.page)break;t.setScenePath([o.displaySceneDir,a].join("/")),t.updateAttributes(["page"],a),E(l.PrevPage,{})}break}case l.SetPage:{const a=Number(c.payload)||0;if(t.getIsWritable()&&i)if(!a)i.removeScenes(o.displaySceneDir);else{const p=i.entireScenes()[o.displaySceneDir];(!p||p.length!==a)&&(i.removeScenes(o.displaySceneDir),i.putScenes(o.displaySceneDir,Q(a))),t.setScenePath(`${o.displaySceneDir}/1`),t.updateAttributes(["maxPage"],a)}break}case l.PageTo:{const a=c.payload;if(t.getIsWritable()&&i){if(!Number.isSafeInteger(a)||a<=0)break;t.setScenePath(`${o.displaySceneDir}/${a}`),t.updateAttributes(["page"],a),E(l.PageTo,a-1)}break}case l.SDKCreate:{G();break}case l.GetAttributes:{g({kind:l.GetAttributes,payload:R(o.state)});break}default:console.warn(`[IframeBridge]: unknown event kind "${c.kind}"`)}}),t.emitter.on("destroy",()=>{console.log("[IframeBridge]: destroy"),y.emit(l.Destroy),n.flushAll(),x(),f.remove()}),z}};export{pe as default};
//# sourceMappingURL=main.es.335a9df7.js.map

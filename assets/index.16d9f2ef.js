var T=Object.defineProperty;var b=(r,i,e)=>i in r?T(r,i,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[i]=e;var h=(r,i,e)=>(b(r,typeof i!="symbol"?i+"":i,e),e);import{c as C,a as E,b as A,d as $,e as U}from"./agora.7ea1cd24.js";import{S as P,R as N,c as O,aP as y,V as _,aQ as k}from"./index.43c4ffc0.js";class q{constructor(){h(this,"sideEffect",new P);h(this,"events",new N)}async destroy(){this.events.destroy(),this.sideEffect.flushAll()}}var V={exports:{}};(function(r,i){(function(e,n){r.exports=n()})(O,function(){var e={delay:100};function n(t,o){for(var s=0;;)try{return o({count:s})}catch(a){if(s<t.count&&t.handleFn(a))t.loggerFn(a),s++;else throw a}}function d(t,o){var s=0;return new Promise(function(a,f){function c(){var g=o({count:s});g.then(function(u){a(u)},function(u){s<t.count&&t.handleFn(u)?(t.loggerFn(u),s++,c()):f(u)})}c()})}function l(t,o){var s=0;return new Promise(function(a,f){function c(){var g=o({count:s});g.then(function(u){a(u)},function(u){var D=t.delays.shift();D&&t.handleFn(u)?(t.loggerFn(u),s++,setTimeout(c,D)):f(u)})}c()})}function m(t,o,s){var a=0;function f(c,g){c&&a<t.count&&t.handleFn(c)?(t.loggerFn(c),a++,o(f,{count:a})):s(c,g)}o(f,{count:a})}function p(t,o,s){var a=0;function f(c,g){var u=t.delays.shift();c&&u&&t.handleFn(c)?(t.loggerFn(c),a++,setTimeout(function(){o(f,{count:a})},u)):s(c,g)}o(f,{count:a})}function I(t){for(var o=[],s=e.delay,a=0;a<t;a++)o.push(s),s=2*s;return o}var S=function(){var t={count:1,delays:[e.delay],handleFn:function(){return!0},loggerFn:function(o){}};return{logger:function(o){return typeof o=="function"&&(t.loggerFn=o),this},handle:function(o){return typeof o=="function"&&(t.handleFn=o),this},retry:function(o){return typeof o=="number"&&(t.count=o),{execute:n.bind(null,t),executeForPromise:d.bind(null,t),executeForNode:m.bind(null,t)}},waitAndRetry:function(o){return typeof o=="number"&&(o=I(o)),Array.isArray(o)&&(t.delays=o),{executeForPromise:l.bind(null,t),executeForNode:p.bind(null,t)}}}};return S.defaults=e,S})})(V);const L=V.exports,w=144,j=108,B=17,F=w*B,G={channelType:0,transcodingConfig:{width:F,height:j,fps:15,bitrate:500,mixedVideoLayout:3,backgroundColor:"#FFFFFF",defaultUserBackgroundImage:"https://flat-storage.oss-cn-hangzhou.aliyuncs.com/flat-resources/cloud-recording/default-avatar.jpg",layoutConfig:[{x_axis:0,y_axis:0,width:w/F,height:1}],backgroundConfig:[]},maxIdleTime:60,subscribeUidGroup:3};function H(r){switch(r){case y.BigClass:case y.SmallClass:case y.OneToOne:return G;default:throw new Error("Unknown room type "+JSON.stringify(r))}}function J(r,i){const e=i.map(n=>({uid:n.uid,image_url:n.avatar}));if(r===y.BigClass||r===y.SmallClass||r===y.OneToOne)return{mixedVideoLayout:3,backgroundColor:"#FFFFFF",defaultUserBackgroundImage:"https://flat-storage.oss-cn-hangzhou.aliyuncs.com/flat-resources/cloud-recording/default-avatar.jpg",backgroundConfig:e,layoutConfig:i.map((n,d)=>({x_axis:d*w/F,y_axis:0,width:w/F,height:1}))};throw new Error("Unknown room type "+JSON.stringify(r))}const R=class extends q{constructor(){super();h(this,"roomInfo");h(this,"recordingState");h(this,"$Val");this.roomInfo=null,this.recordingState=null,this.$Val={isRecording$:new _(!1)}}get roomID(){var e,n;return(n=(e=this.roomInfo)==null?void 0:e.roomID)!=null?n:null}get isRecording(){return this.$Val.isRecording$.value}async joinRoom(e){this.roomInfo=e,this.recordingState=K(e.roomID),await this.queryRecordingStatus()}async leaveRoom(){this.isRecording&&await this.stopRecording().catch(console.error),this.roomInfo=null,this.recordingState=null,this.$Val.isRecording$.setValue(!1)}async startRecording(){if(this.roomInfo===null)throw new Error("should call joinRoom() before startRecording()");if(await this.queryRecordingStatus(),this.isRecording)return;const e="mix",{roomID:n,classroomType:d}=this.roomInfo;try{const l=[0,1e3,3e3,5e3,7e3],m=await L().waitAndRetry(5).executeForPromise(async({count:p})=>{p&&await W(l[p]);const{resourceId:I}=await C({roomUUID:n,agoraData:{clientRequest:{resourceExpiredHour:24}}}),{sid:S}=await E({roomUUID:n,agoraParams:{resourceid:I,mode:e},agoraData:{clientRequest:{recordingConfig:H(d)}}});return{resourceId:I,sid:S,mode:e}});this.recordingState=m,v(n,m),this.$Val.isRecording$.setValue(!0),this.startReportingEndTime()}catch(l){throw this.$Val.isRecording$.setValue(!1),l}}async stopRecording(){if(this.roomInfo===null){console.warn("should call joinRoom() before stopRecording()");return}if(await this.queryRecordingStatus(),this.recordingState===null)return;const{roomID:e}=this.roomInfo,{resourceId:n,sid:d,mode:l}=this.recordingState;this.sideEffect.flush(R.ReportingEndTimeKey),this.recordingState=null;try{v(e,null),await A({roomUUID:e,agoraParams:{resourceid:n,sid:d,mode:l}})}finally{this.$Val.isRecording$.setValue(!1)}}async updateLayout(e){if(this.roomInfo===null||this.recordingState===null)throw new Error("should call joinRoom() and startRecording() before updateLayout()");const{roomID:n,classroomType:d}=this.roomInfo,l=J(d,e);await $({roomUUID:n,agoraParams:{resourceid:this.recordingState.resourceId,mode:this.recordingState.mode,sid:this.recordingState.sid},agoraData:{clientRequest:l}})}async queryRecordingStatus(){if(this.recordingState===null||this.roomID===null){this.$Val.isRecording$.setValue(!1);return}try{const{resourceId:e,sid:n,mode:d}=this.recordingState,{serverResponse:l}=await U({roomUUID:this.roomID,agoraParams:{resourceid:e,sid:n,mode:d}}),m=1<=l.status&&l.status<=5;this.$Val.isRecording$.setValue(m)}catch{this.recordingState=null,this.$Val.isRecording$.setValue(!1),this.roomID&&v(this.roomID,null)}}startReportingEndTime(){this.sideEffect.setInterval(()=>{var n;const e=(n=this.roomInfo)==null?void 0:n.roomID;this.isRecording&&e?k(e):this.sideEffect.flush(R.ReportingEndTimeKey)},10*1e3,R.ReportingEndTimeKey)}};let x=R;h(x,"ReportingEndTimeKey","reportingEndTime");function K(r){var e;let i;try{i=JSON.parse(localStorage.getItem("recordingStates")||"{}")}catch{i={}}return(e=i[r])!=null?e:null}function v(r,i){let e;try{e=JSON.parse(localStorage.getItem("recordingStates")||"{}")}catch{e={}}i===null?delete e[r]:e[r]=i,localStorage.setItem("recordingStates",JSON.stringify(e))}function W(r){return new Promise(i=>setTimeout(i,r))}export{x as AgoraCloudRecording};
//# sourceMappingURL=index.16d9f2ef.js.map

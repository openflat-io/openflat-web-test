{"version":3,"file":"index.ce79cd5c.js","sources":["../../../../packages/flat-pages/src/ModifyPeriodicRoomPage/index.tsx"],"sourcesContent":["import { message } from \"antd\";\nimport React, { useEffect, useState } from \"react\";\nimport { observer } from \"mobx-react-lite\";\nimport { useHistory, useParams } from \"react-router-dom\";\nimport {\n    EditRoomFormInitialValues,\n    EditRoomFormValues,\n    getEndTimeFromRate,\n    getRateFromEndTime,\n    LoadingPage,\n    errorTips,\n} from \"flat-components\";\nimport { useSafePromise } from \"../utils/hooks/lifecycle\";\nimport EditRoomPage from \"../components/EditRoomPage\";\nimport { RouteNameType, RouteParams, usePushHistory } from \"../utils/routes\";\nimport { periodicRoomInfo, updatePeriodicRoom } from \"@netless/flat-server-api\";\nimport { useLoginCheck } from \"../utils/use-login-check\";\n\n/**\n * TODO: we forget set i18n in current file!!!\n */\n\ntype ModifyPeriodicRoomPageProps = {\n    periodicUUID: string;\n};\n\nexport const ModifyPeriodicRoomPage = observer<ModifyPeriodicRoomPageProps>(\n    function ModifyPeriodicRoomPage() {\n        useLoginCheck();\n\n        const { periodicUUID } = useParams<RouteParams<RouteNameType.ModifyPeriodicRoomPage>>();\n        const history = useHistory();\n        const pushHistory = usePushHistory();\n        const sp = useSafePromise();\n        const [isLoading, setLoading] = useState(false);\n        const [initialValues, setInitialValues] = useState<EditRoomFormInitialValues>();\n\n        useEffect(() => {\n            sp(periodicRoomInfo(periodicUUID))\n                .then(({ periodic, rooms }) => {\n                    const beginTime = new Date(rooms[0].beginTime);\n                    const periodicEndTime = new Date(periodic.endTime);\n                    setInitialValues({\n                        title: periodic.title,\n                        type: periodic.roomType,\n                        beginTime,\n                        endTime: new Date(rooms[0].endTime),\n                        isPeriodic: true,\n                        region: periodic.region,\n                        periodic:\n                            periodic.rate === null || periodic.rate === void 0\n                                ? {\n                                      weeks: periodic.weeks,\n                                      endType: \"time\",\n                                      ...getRateFromEndTime(\n                                          beginTime,\n                                          periodic.weeks,\n                                          periodicEndTime,\n                                      ),\n                                  }\n                                : {\n                                      weeks: periodic.weeks,\n                                      endType: \"rate\",\n                                      rate: periodic.rate,\n                                      endTime: getEndTimeFromRate(\n                                          beginTime,\n                                          periodic.weeks,\n                                          periodic.rate,\n                                      ),\n                                  },\n                    });\n                })\n                .catch(e => {\n                    console.error(e);\n                    errorTips(e);\n                    history.goBack();\n                });\n            // Only listen to roomUUID\n            // eslint-disable-next-line react-hooks/exhaustive-deps\n        }, [periodicUUID]);\n\n        if (!initialValues) {\n            return <LoadingPage />;\n        }\n\n        return (\n            <EditRoomPage\n                initialValues={initialValues}\n                loading={isLoading}\n                type=\"periodic\"\n                onSubmit={editPeriodicRoom}\n            />\n        );\n\n        async function editPeriodicRoom(values: EditRoomFormValues): Promise<void> {\n            setLoading(true);\n\n            try {\n                await sp(\n                    updatePeriodicRoom({\n                        periodicUUID: periodicUUID,\n                        beginTime: values.beginTime.valueOf(),\n                        endTime: values.endTime.valueOf(),\n                        title: values.title,\n                        type: values.type,\n                        periodic:\n                            values.periodic.endType === \"rate\"\n                                ? {\n                                      weeks: values.periodic.weeks,\n                                      rate: values.periodic.rate,\n                                  }\n                                : {\n                                      weeks: values.periodic.weeks,\n                                      endTime: values.periodic.endTime.valueOf(),\n                                  },\n                    }),\n                );\n                void message.success(\"修改成功\");\n                pushHistory(RouteNameType.HomePage);\n            } catch (e) {\n                console.error(e);\n                errorTips(e);\n                setLoading(false);\n            }\n        }\n    },\n);\n\nexport default ModifyPeriodicRoomPage;\n"],"names":["ModifyPeriodicRoomPage","observer","useLoginCheck","periodicUUID","useParams","history","useHistory","pushHistory","usePushHistory","sp","useSafePromise","isLoading","setLoading","useState","initialValues","setInitialValues","useEffect","periodicRoomInfo","then","periodic","rooms","beginTime","Date","periodicEndTime","endTime","title","type","roomType","isPeriodic","region","rate","weeks","endType","getRateFromEndTime","getEndTimeFromRate","catch","console","error","e","errorTips","goBack","_jsx","LoadingPage","EditRoomPage","editPeriodicRoom","values","updatePeriodicRoom","valueOf","message","success","RouteNameType","HomePage"],"mappings":"qTA0BaA,MAAAA,EAAyBC,EAClC,UAAkC,CACjBC,IAEP,KAAA,CAAEC,aAAAA,GAAiBC,EAAzB,EACMC,EAAUC,IACVC,EAAcC,IACdC,EAAKC,IACL,CAACC,EAAWC,CAAZ,EAA0BC,mBAAS,EAAD,EAClC,CAACC,EAAeC,CAAhB,EAAoCF,EAA1C,QAAA,SAAA,EA8CA,GA5CAG,EAAAA,QAAAA,UAAU,IAAM,CACZP,EAAGQ,EAAiBd,CAAD,CAAjB,EACGe,KAAK,CAAC,CAAEC,SAAAA,EAAUC,MAAAA,CAAAA,IAAY,CAC3B,MAAMC,EAAY,IAAIC,KAAKF,EAAM,GAAGC,SAAlB,EACZE,EAAkB,IAAID,KAAKH,EAASK,OAAlB,EACPT,EAAA,CACbU,MAAON,EAASM,MAChBC,KAAMP,EAASQ,SACfN,UAAAA,EACAG,QAAS,IAAIF,KAAKF,EAAM,GAAGI,OAAlB,EACTI,WAAY,GACZC,OAAQV,EAASU,OACjBV,SACIA,EAASW,OAAS,MAAQX,EAASW,OAAS,OACtC,CACIC,MAAOZ,EAASY,MAChBC,QAAS,OACT,GAAGC,EACCZ,EACAF,EAASY,MACTR,CAHiB,CAAA,EAMzB,CACIQ,MAAOZ,EAASY,MAChBC,QAAS,OACTF,KAAMX,EAASW,KACfN,QAASU,EACLb,EACAF,EAASY,MACTZ,EAASW,IAHc,CAJ/B,CAAA,CAlBE,CAAA,CAJxB,EAkCKK,MAAW,GAAA,CACRC,QAAQC,MAAMC,CAAd,EACAC,EAAUD,CAAD,EACTjC,EAAQmC,OAAR,CAAA,CArCR,CAAA,EAyCD,CAACrC,CAAD,CA1CM,EA4CL,CAACW,EACM,OAAA2B,EAACC,EAAR,CAAA,CAAA,EAGJ,SACKC,EAAD,CACI,cAAA7B,EACA,QAASH,EACT,KAAK,WACL,SAAUiC,CAAAA,CALlB,EASA,eAAeA,EAAiBC,EAA2C,CACvEjC,EAAW,EAAD,EAEN,GAAA,CACA,MAAMH,EACFqC,EAAmB,CACf3C,aAAAA,EACAkB,UAAWwB,EAAOxB,UAAU0B,QAFb,EAGfvB,QAASqB,EAAOrB,QAAQuB,QAHT,EAIftB,MAAOoB,EAAOpB,MACdC,KAAMmB,EAAOnB,KACbP,SACI0B,EAAO1B,SAASa,UAAY,OACtB,CACID,MAAOc,EAAO1B,SAASY,MACvBD,KAAMe,EAAO1B,SAASW,IAAAA,EAE1B,CACIC,MAAOc,EAAO1B,SAASY,MACvBP,QAASqB,EAAO1B,SAASK,QAAQuB,QAAxB,CAFb,CAZI,CAAA,CADd,EAmBHC,EAAQC,QAAQ,0BAAhB,EACL1C,EAAY2C,EAAcC,QAAf,QACNb,GACLF,QAAQC,MAAMC,CAAd,EACAC,EAAUD,CAAD,EACT1B,EAAW,EAAD,CACb,CACJ,CACJ,CAnGyC"}
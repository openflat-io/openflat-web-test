{"version":3,"file":"index.cdec5d78.js","sources":["../../../../packages/flat-pages/src/components/AppUpgradeModal/index.tsx"],"sourcesContent":["import \"./index.less\";\n\nimport React, { useCallback, useContext, useEffect, useState } from \"react\";\nimport { Button, Modal } from \"antd\";\nimport { observer } from \"mobx-react-lite\";\n\nimport { update } from \"flat-types\";\nimport { useTranslate } from \"@netless/flat-i18n\";\n\nimport { useSafePromise } from \"../../utils/hooks/lifecycle\";\nimport { AutoUpdateContext, RuntimeContext } from \"../StoreProvider\";\n\nexport type UpdateInfo = update.UpdateCheckInfo & {\n    hasNewVersion: true;\n};\n\nexport interface AutoUpdateState {\n    checkUpdate: () => void;\n    updateInfo: UpdateInfo | null;\n    setUpdateInfo: (info: UpdateInfo | null) => void;\n    loading: boolean;\n    percent: number;\n    isStarted: boolean;\n    isFailed: boolean;\n    startUpdate: () => void;\n    cancelUpdate: () => void;\n}\n\nexport function useAutoUpdate(): AutoUpdateState {\n    const sp = useSafePromise();\n    const runtime = useContext(RuntimeContext);\n    const autoUpdate = useContext(AutoUpdateContext);\n\n    const [updateInfo, setUpdateInfo] = useState<UpdateInfo | null>(null);\n    const [loading, setLoading] = useState(false);\n\n    const [percent, setPercent] = useState(0);\n    const [isStarted, start] = useState(false);\n    const [isFailed, fail] = useState(false);\n\n    const startUpdate = useCallback(() => start(true), []);\n    const cancelUpdate = useCallback(() => start(false), []);\n\n    const checkUpdate = useCallback(async () => {\n        if (autoUpdate && runtime) {\n            setLoading(true);\n            try {\n                const e = await sp(autoUpdate.getUpdateInfo());\n                setLoading(false);\n                if (!e || !e.hasNewVersion || e.version === runtime.appVersion) {\n                    console.log(\"[Auto Updater] No new version\");\n                } else {\n                    console.log(\"[Auto Updater] New version found\", e);\n                    setUpdateInfo(e);\n                }\n            } catch (e) {\n                console.error(e);\n            }\n        }\n    }, [autoUpdate, runtime, sp]);\n\n    useEffect(() => {\n        if (autoUpdate && isStarted && updateInfo) {\n            const stopListenProgress = autoUpdate.onUpdateProgress(e => {\n                if (e.status) {\n                    setPercent(e.percent);\n                } else {\n                    fail(true);\n                }\n            });\n            autoUpdate.startUpdate(updateInfo.prereleaseTag);\n            return stopListenProgress;\n        }\n        return;\n    }, [autoUpdate, isStarted, updateInfo]);\n\n    return {\n        checkUpdate,\n        updateInfo,\n        setUpdateInfo,\n        loading,\n        percent,\n        isStarted,\n        isFailed,\n        startUpdate,\n        cancelUpdate,\n    };\n}\n\nexport const AppUpgradeModal = observer(function AppUpgradeModal() {\n    const t = useTranslate();\n    const {\n        checkUpdate,\n        updateInfo,\n        setUpdateInfo,\n        percent,\n        isStarted,\n        isFailed,\n        startUpdate,\n        cancelUpdate,\n    } = useAutoUpdate();\n\n    useEffect(() => {\n        checkUpdate();\n    }, [checkUpdate]);\n\n    const onCancel = useCallback(() => {\n        cancelUpdate();\n        setUpdateInfo(null);\n    }, [cancelUpdate, setUpdateInfo]);\n\n    return (\n        <Modal\n            closable={false}\n            footer={[]}\n            keyboard={false}\n            maskClosable={false}\n            open={updateInfo !== null}\n            title={<div className=\"app-upgrade-modal-title\">{t(\"version-updates\")}</div>}\n            width={386}\n            wrapClassName=\"app-upgrade-modal-container\"\n            onCancel={onCancel}\n        >\n            {isStarted ? (\n                <div>\n                    <span className=\"app-upgrade-modal-font\">\n                        {t(\"downloading\")} ({percent.toFixed(2)}%)...\n                    </span>\n                    <div className=\"app-upgrade-modal-progress\" />\n                    <div className=\"app-upgrade-active-progress\" style={{ width: `${percent}%` }} />\n                    {isFailed && (\n                        <div>\n                            <span className=\"app-upgrade-modal-font\">\n                                {t(\"update-failed-tips\")}\n                            </span>\n                            <div className=\"app-upgrade-modal-btn\">\n                                <Button type=\"primary\" onClick={() => window.close()}>\n                                    {t(\"confirm\")}\n                                </Button>\n                            </div>\n                        </div>\n                    )}\n                </div>\n            ) : (\n                <div>\n                    <span className=\"app-upgrade-modal-font\">\n                        {t(\"new-version-tips\", { version: updateInfo?.version || \" \" })}\n                    </span>\n                    <div className=\"app-upgrade-modal-btn\">\n                        <Button type=\"primary\" onClick={startUpdate}>\n                            {t(\"update-now\")}\n                        </Button>\n                    </div>\n                </div>\n            )}\n        </Modal>\n    );\n});\n"],"names":["useAutoUpdate","sp","useSafePromise","runtime","useContext","RuntimeContext","autoUpdate","AutoUpdateContext","updateInfo","setUpdateInfo","useState","loading","setLoading","percent","setPercent","isStarted","start","isFailed","fail","startUpdate","useCallback","cancelUpdate","checkUpdate","e","getUpdateInfo","hasNewVersion","version","appVersion","console","log","error","useEffect","stopListenProgress","onUpdateProgress","status","prereleaseTag","AppUpgradeModal","observer","t","useTranslate","onCancel","Modal","_jsxs","toFixed","_jsx","width","Button","window","close"],"mappings":"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"}